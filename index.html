<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
		<title>Ivage Calendar Creator</title>
		<meta name="description" content="Creates iCal based on Ivago data">
		<meta name="viewport" content="width=device-width, initial-scale=1">

		<link rel="stylesheet" href="css/bootstrap.min.css">
		<style>
			body {
				padding-top: 50px;
				padding-bottom: 20px;
      }
		</style>
		<link rel="stylesheet" href="css/bootstrap-theme.min.css">
		<link rel="stylesheet" href="css/main.css">

		<script src="js/vendor/modernizr-2.6.2-respond-1.1.0.min.js"></script>
	</head>
	<body>
		<!--[if lt IE 7]>
		<p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
		<![endif]-->
		<div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
			<div class="container">
				<div class="navbar-header">
					<a class="navbar-brand" href="#">Common Tools</a>
				</div>
				<!--/.navbar-collapse -->
			</div>
		</div>

		<!-- Main jumbotron for a primary marketing message or call to action -->
		<div class="jumbotron">
			<div class="container">
				<h1>Ivago Calendar Creator</h1>
				<p>This page allows you to create a calendar in iCal format for the garbage collection rounds of Ivago, Ghent. The iCal format is a widely used format, understood by most calendering applications, among other Google Calendar, Mozilla Thunderbird, Microsoft Outlook...</p>
				<!--p><a class="btn btn-primary btn-lg" role="button">Learn more &raquo;</a></p-->
			</div>
		</div>

		<div class="container">
			<h3>Calendar settings</h3>
			<p>Select your address and desired calendar properties. This information is needed to find your zone. Garbage collection calendars depend on the zone in which you live. Under no circumstance will this information be stored or shared with third parties.</p>
			<form method="get" action="create_ical.html" role="form">
				<div class="form-group">
					<div data-bind="visible: !dataLoaded()">
						<img src="img/ajax-loader.gif"/>
						<span>Loading data ...</span>
					</div>
				</div>
				<div class="form-group form-inline">
					<select data-bind="
						options: allCommunities,
						optionsText: 'name',
						optionsCaption: 'Choose community',
						value: selectedCommunity,
						enable: dataLoaded" class="form-control"></select>
					<select data-bind="
						options: communityStreets,
						optionsText: 'name',
						value: selectedStreet,
						optionsCaption: 'Choose street...',
						enable: selectedCommunity" class="form-control"></select> 
					<select data-bind="
						options: streetDivisions,
						optionsText: 'label',
						value: selectedStreetDivision,
						optionsCaption: 'Choose street part...',
						enable: isStreetDivided
						visible: isStreetDivided" class="form-control"></select> 
				</div>
				<div class="form-group" data-bind="visible: selectedSector()">
					<p>You are in sector: <span data-bind="text: selectedSector()"> </span></p>
				</div>
				<input data-bind="value: selectedSector()" type="hidden" name="sector"/>
				<button type="submit" class="btn btn-default">Create iCal &raquo;</button>
			</form>
			<hr>

			<footer>
				<p>&copy; drhoet 2014</p>
			</footer>
		</div> <!-- /container -->

		<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
		<script>window.jQuery || document.write('<scr'+'ipt src="js/vendor/jquery-1.11.0.min.js"><\/script>')</script>
		<script src="js/vendor/bootstrap.min.js"></script>
		<script type='text/javascript' src='js/vendor/knockout-3.1.0.js'></script>
		<script src="js/main.js"></script>
		<script language="javascript">
			var SelectZoneViewModel = function() {
				this.allCommunities = ko.observableArray([]);
				this.dataLoaded = ko.observable(false);
				this.selectedCommunity = ko.observable();

				this.streetsLoaded = ko.observable(true);
				this.selectedStreet = ko.observable();
				this.selectedStreetDivision = ko.observable();

				this.loadData = function(data) {
					var communityLookupMap = {};
					for(var i = 0; i < data.length; ++i) {
						if(!(data[i].gemeente in communityLookupMap)) {
							var newCommunity = { name: data[i].gemeente, streets: [] };
							this.allCommunities.push(newCommunity);
							// I need an array of items to be shown in the dropdown
							// + I need a map to be able to quickly find whether a street is already added
							communityLookupMap[data[i].gemeente] = { community: newCommunity, streetLookupMap: {} };
						}
						var communityWrapper = communityLookupMap[data[i].gemeente];
						if(!(data[i].straatnaam in communityWrapper.streetLookupMap)) {
							var newStreet = { name: data[i].straatnaam, divisions: [] };
							communityWrapper.community.streets.push(newStreet);
							communityWrapper.streetLookupMap[data[i].straatnaam] = newStreet;
						}
						communityWrapper.streetLookupMap[data[i].straatnaam].divisions.push(data[i]);
					}
					this.allCommunities.sort(function(a, b) { return a.name.localeCompare(b.name); } );
					this.dataLoaded(true);
				};

				this.communityStreets = ko.computed(function() {
					if(this.selectedCommunity()) {
						return this.selectedCommunity().streets;
					} else {
						return [];
					}
				}, this);

				this.isStreetDivided = ko.computed(function() {
					return this.selectedCommunity() && this.selectedStreet() && this.selectedStreet().divisions.length > 1;
				}, this);

				this.streetDivisions = ko.computed(function() {
					if(this.isStreetDivided()) {
						var partsObjects = this.selectedStreet().divisions;
						var partsTexts = [];
						for(var i=0; i<partsObjects.length; ++i) {
							pushText(partsTexts, partsObjects[i], "even van ", "even tot", " (even)");
							pushText(partsTexts, partsObjects[i], "oneven van ", "oneven tot", " (odd)");
						}
						return partsTexts;
					} else {
						return [];
					}
				}, this);

				this.selectedSector = ko.computed(function() {
					if(this.selectedCommunity() && this.selectedStreet()) {
						if(this.isStreetDivided()) {
							if(this.selectedStreetDivision()) {
								return this.selectedStreetDivision().value;
							} else {
								return null;
							}
						} else {
							return this.selectedStreet().divisions[0].sector;
						}
					} else {
						return null;
					}
				}, this);
			};

			function pushText(target, obj, startField, stopField, postfix) {
				if(obj[startField] != "" && obj[startField] != "-1") {
					target.push({ label: obj[startField] + "-" + obj[stopField] + postfix, value: obj['sector']});
				}
			}

			var model = new SelectZoneViewModel();
			ko.applyBindings(model);
			jQuery.getJSON("http://datatank.gent.be/MilieuEnNatuur/IVAGO-Stratenlijst.json", function(data){
				model.loadData(data["IVAGO-Stratenlijst"]);
			});
		</script>
	</body>
</html>
